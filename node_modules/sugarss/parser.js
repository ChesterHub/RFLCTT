'use strict';

exports.__esModule = true;

var _declaration = require('postcss/lib/declaration');

var _declaration2 = _interopRequireDefault(_declaration);

var _comment = require('postcss/lib/comment');

var _comment2 = _interopRequireDefault(_comment);

var _atRule = require('postcss/lib/at-rule');

var _atRule2 = _interopRequireDefault(_atRule);

var _rule = require('postcss/lib/rule');

var _rule2 = _interopRequireDefault(_rule);

var _root = require('postcss/lib/root');

var _root2 = _interopRequireDefault(_root);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Parser = function () {
    function Parser(input) {
        _classCallCheck(this, Parser);

        this.input = input;

        this.pos = 0;
        this.root = new _root2.default();
        this.current = this.root;
        this.spaces = '';

        this.prevIndent = undefined;
        this.step = undefined;

        this.root.source = { input: input, start: { line: 1, column: 1 } };
    }

    Parser.prototype.loop = function loop() {
        var part = void 0;
        while (this.pos < this.parts.length) {
            part = this.parts[this.pos];

            if (part.comment) {
                this.comment(part);
            } else if (part.atrule) {
                this.atrule(part);
            } else if (part.colon) {
                var next = this.nextNonComment(this.pos);

                if (next.end || next.atrule) {
                    this.decl(part);
                } else {
                    var moreIndent = next.indent.length > part.indent.length;
                    if (!moreIndent) {
                        this.decl(part);
                    } else if (moreIndent && next.colon) {
                        this.rule(part);
                    } else if (moreIndent && !next.colon) {
                        this.decl(part);
                    }
                }
            } else if (part.end) {
                this.root.raws.after = part.before;
            } else {
                this.rule(part);
            }

            this.pos += 1;
        }
    };

    Parser.prototype.comment = function comment(part) {
        var token = part.tokens[0];
        var node = new _comment2.default();
        this.init(node, part);
        node.source.end = { line: token[4], column: token[5] };
        this.commentText(node, token);
    };

    Parser.prototype.atrule = function atrule(part) {
        var atword = part.tokens[0];
        var params = part.tokens.slice(1);

        var node = new _atRule2.default();
        node.name = atword[1].slice(1);
        this.init(node, part);

        if (node.name === '') this.unnamedAtrule(atword);

        while (!part.end && part.lastComma) {
            this.pos += 1;
            part = this.parts[this.pos];
            params.push(['space', part.before + part.indent]);
            params = params.concat(part.tokens);
        }

        node.raws.afterName = this.firstSpaces(params);
        this.keepTrailingSpace(node, params);
        this.raw(node, 'params', params, atword);
    };

    Parser.prototype.decl = function decl(part) {
        var node = new _declaration2.default();
        this.init(node, part);

        var between = '';
        var colon = 0;
        var value = [];
        var prop = '';
        for (var i = 0; i < part.tokens.length; i++) {
            var token = part.tokens[i];
            if (token[0] === ':') {
                between += token[1];
                colon = token;
                value = part.tokens.slice(i + 1);
                break;
            } else if (token[0] === 'comment' || token[0] === 'space') {
                between += token[1];
            } else if (between !== '') {
                this.badProp(token);
            } else {
                prop += token[1];
            }
        }

        if (prop === '') this.unnamedDecl(part.tokens[0]);
        node.prop = prop;

        var next = this.parts[this.pos + 1];

        while (!next.end && !next.atrule && !next.colon && next.indent.length > part.indent.length) {
            value.push(['space', next.before + next.indent]);
            value = value.concat(next.tokens);
            this.pos += 1;
            next = this.parts[this.pos + 1];
        }

        var last = value[value.length - 1];
        if (last && last[0] === 'comment') {
            value.pop();
            var comment = new _comment2.default();
            this.current.push(comment);
            comment.source = {
                input: this.input,
                start: { line: last[2], column: last[3] },
                end: { line: last[4], column: last[5] }
            };
            var prev = value[value.length - 1];
            if (prev && prev[0] === 'space') {
                value.pop();
                comment.raws.before = prev[1];
            }
            this.commentText(comment, last);
        }

        for (var _i = value.length - 1; _i > 0; _i--) {
            var t = value[_i][0];
            if (t === 'word' && value[_i][1] === '!important') {
                node.important = true;
                if (_i > 0 && value[_i - 1][0] === 'space') {
                    node.raws.important = value[_i - 1][1] + '!important';
                    value.splice(_i - 1, 2);
                } else {
                    node.raws.important = '!important';
                    value.splice(_i, 1);
                }
                break;
            } else if (t !== 'space' && t !== 'newline' && t !== 'comment') {
                break;
            }
        }

        node.raws.between = between + this.firstSpaces(value);
        this.raw(node, 'value', value, colon);
    };

    Parser.prototype.rule = function rule(part) {
        var node = new _rule2.default();
        this.init(node, part);

        var selector = part.tokens;
        var next = this.parts[this.pos + 1];

        while (!next.end && next.indent.length === part.indent.length) {
            selector.push(['space', next.before + next.indent]);
            selector = selector.concat(next.tokens);
            this.pos += 1;
            next = this.parts[this.pos + 1];
        }

        this.keepTrailingSpace(node, selector);
        this.raw(node, 'selector', selector);
    };

    /* Helpers */

    Parser.prototype.indent = function indent(part) {
        var indent = part.indent.length;
        var isPrev = typeof this.prevIndent !== 'undefined';

        if (!isPrev && indent) this.indentedFirstLine(part);

        if (!this.step && indent) {
            this.step = indent;
            this.root.raws.indent = part.indent;
        }

        if (isPrev && this.prevIndent !== indent) {
            var diff = indent - this.prevIndent;
            if (diff > 0) {
                if (diff !== this.step) {
                    this.wrongIndent(this.prevIndent + this.step, indent, part);
                } else {
                    this.current = this.current.last;
                }
            } else if (diff % this.step !== 0) {
                var m = indent + diff % this.step;
                this.wrongIndent(m + ' or ' + (m + this.step), indent, part);
            } else {
                for (var i = 0; i < -diff / this.step; i++) {
                    this.current = this.current.parent;
                }
            }
        }

        this.prevIndent = indent;
    };

    Parser.prototype.init = function init(node, part) {
        this.indent(part);

        if (!this.current.nodes) this.current.nodes = [];
        this.current.push(node);

        node.raws.before = part.before + part.indent;
        node.source = {
            start: { line: part.tokens[0][2], column: part.tokens[0][3] },
            input: this.input
        };
    };

    Parser.prototype.keepTrailingSpace = function keepTrailingSpace(node, tokens) {
        var lastSpace = tokens[tokens.length - 1];
        if (lastSpace && lastSpace[0] === 'space') {
            tokens.pop();
            node.raws.sssBetween = lastSpace[1];
        }
    };

    Parser.prototype.firstSpaces = function firstSpaces(tokens) {
        var result = '';
        for (var i = 0; i < tokens.length; i++) {
            if (tokens[i][0] === 'space' || tokens[i][0] === 'newline') {
                result += tokens.shift()[1];
                i -= 1;
            } else {
                break;
            }
        }
        return result;
    };

    Parser.prototype.raw = function raw(node, prop, tokens, altLast) {
        var token = void 0,
            type = void 0;
        var length = tokens.length;
        var value = '';
        var clean = true;
        for (var i = 0; i < length; i += 1) {
            token = tokens[i];
            type = token[0];
            if (type === 'comment' || type === 'space' && i === length - 1) {
                clean = false;
            } else {
                value += token[1];
            }
        }
        if (!clean) {
            var sss = tokens.reduce(function (all, i) {
                return all + i[1];
            }, '');
            var raw = tokens.reduce(function (all, i) {
                if (i[0] === 'comment' && i[6] === 'inline') {
                    return all + '/* ' + i[1].slice(2).trim() + ' */';
                } else {
                    return all + i[1];
                }
            }, '');
            node.raws[prop] = { value: value, raw: raw };
            if (sss !== raw) node.raws[prop].sss = sss;
        }
        node[prop] = value;

        var last = tokens[tokens.length - 1] || altLast;
        node.source.end = {
            line: last[4] || last[2],
            column: last[5] || last[3]
        };
    };

    Parser.prototype.nextNonComment = function nextNonComment(pos) {
        var next = pos;
        var part = void 0;
        while (next < this.parts.length) {
            next += 1;
            part = this.parts[next];
            if (part.end || !part.comment) break;
        }
        return part;
    };

    Parser.prototype.commentText = function commentText(node, token) {
        var text = token[1];
        if (token[6] === 'inline') {
            node.raws.inline = true;
            text = text.slice(2);
        } else {
            text = text.slice(2, -2);
        }

        var match = text.match(/^(\s*)([^]*[^\s])(\s*)\n?$/);
        node.text = match[2];
        node.raws.left = match[1];
        node.raws.inlineRight = match[3];
    };

    // Errors

    Parser.prototype.error = function error(msg, line, column) {
        throw this.input.error(msg, line, column);
    };

    Parser.prototype.unnamedAtrule = function unnamedAtrule(token) {
        this.error('At-rule without name', token[2], token[3]);
    };

    Parser.prototype.unnamedDecl = function unnamedDecl(token) {
        this.error('Declaration without name', token[2], token[3]);
    };

    Parser.prototype.indentedFirstLine = function indentedFirstLine(part) {
        this.error('First line should not have indent', part.number, 1);
    };

    Parser.prototype.wrongIndent = function wrongIndent(expected, real, part) {
        var msg = 'Expected ' + expected + ' indent, but get ' + real;
        this.error(msg, part.number, 1);
    };

    Parser.prototype.badProp = function badProp(token) {
        this.error('Unexpected separator in property', token[2], token[3]);
    };

    return Parser;
}();

exports.default = Parser;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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TztBQUNmLGFBQUssS0FBTCxDQUFXLDBCQUFYLEVBQXVDLE1BQU0sQ0FBTixDQUF2QyxFQUFpRCxNQUFNLENBQU4sQ0FBakQ7QUFDSCxLOztxQkFFRCxpQiw4QkFBa0IsSSxFQUFNO0FBQ3BCLGFBQUssS0FBTCxDQUFXLG1DQUFYLEVBQWdELEtBQUssTUFBckQsRUFBNkQsQ0FBN0Q7QUFDSCxLOztxQkFFRCxXLHdCQUFZLFEsRUFBVSxJLEVBQU0sSSxFQUFNO0FBQzlCLFlBQUksb0JBQW1CLFFBQW5CLHlCQUFpRCxJQUFyRDtBQUNBLGFBQUssS0FBTCxDQUFXLEdBQVgsRUFBZ0IsS0FBSyxNQUFyQixFQUE2QixDQUE3QjtBQUNILEs7O3FCQUVELE8sb0JBQVEsSyxFQUFPO0FBQ1gsYUFBSyxLQUFMLENBQVcsa0NBQVgsRUFBK0MsTUFBTSxDQUFOLENBQS9DLEVBQXlELE1BQU0sQ0FBTixDQUF6RDtBQUNILEs7Ozs7O2tCQXhVZ0IsTSIsImZpbGUiOiJwYXJzZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRGVjbGFyYXRpb24gZnJvbSAncG9zdGNzcy9saWIvZGVjbGFyYXRpb24nO1xuaW1wb3J0IENvbW1lbnQgICAgIGZyb20gJ3Bvc3Rjc3MvbGliL2NvbW1lbnQnO1xuaW1wb3J0IEF0UnVsZSAgICAgIGZyb20gJ3Bvc3Rjc3MvbGliL2F0LXJ1bGUnO1xuaW1wb3J0IFJ1bGUgICAgICAgIGZyb20gJ3Bvc3Rjc3MvbGliL3J1bGUnO1xuaW1wb3J0IFJvb3QgICAgICAgIGZyb20gJ3Bvc3Rjc3MvbGliL3Jvb3QnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQYXJzZXIge1xuXG4gICAgY29uc3RydWN0b3IoaW5wdXQpIHtcbiAgICAgICAgdGhpcy5pbnB1dCA9IGlucHV0O1xuXG4gICAgICAgIHRoaXMucG9zICAgICA9IDA7XG4gICAgICAgIHRoaXMucm9vdCAgICA9IG5ldyBSb290KCk7XG4gICAgICAgIHRoaXMuY3VycmVudCA9IHRoaXMucm9vdDtcbiAgICAgICAgdGhpcy5zcGFjZXMgID0gJyc7XG5cbiAgICAgICAgdGhpcy5wcmV2SW5kZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnN0ZXAgICAgICAgPSB1bmRlZmluZWQ7XG5cbiAgICAgICAgdGhpcy5yb290LnNvdXJjZSA9IHsgaW5wdXQsIHN0YXJ0OiB7IGxpbmU6IDEsIGNvbHVtbjogMSB9IH07XG4gICAgfVxuXG4gICAgbG9vcCgpIHtcbiAgICAgICAgbGV0IHBhcnQ7XG4gICAgICAgIHdoaWxlICggdGhpcy5wb3MgPCB0aGlzLnBhcnRzLmxlbmd0aCApIHtcbiAgICAgICAgICAgIHBhcnQgPSB0aGlzLnBhcnRzW3RoaXMucG9zXTtcblxuICAgICAgICAgICAgaWYgKCBwYXJ0LmNvbW1lbnQgKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb21tZW50KHBhcnQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggcGFydC5hdHJ1bGUgKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hdHJ1bGUocGFydCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCBwYXJ0LmNvbG9uICkge1xuICAgICAgICAgICAgICAgIGxldCBuZXh0ID0gdGhpcy5uZXh0Tm9uQ29tbWVudCh0aGlzLnBvcyk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIG5leHQuZW5kIHx8IG5leHQuYXRydWxlICkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY2wocGFydCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG1vcmVJbmRlbnQgPSBuZXh0LmluZGVudC5sZW5ndGggPiBwYXJ0LmluZGVudC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIGlmICggIW1vcmVJbmRlbnQgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY2wocGFydCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIG1vcmVJbmRlbnQgJiYgbmV4dC5jb2xvbiApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucnVsZShwYXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggbW9yZUluZGVudCAmJiAhbmV4dC5jb2xvbiApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjbChwYXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIHBhcnQuZW5kICkge1xuICAgICAgICAgICAgICAgIHRoaXMucm9vdC5yYXdzLmFmdGVyID0gcGFydC5iZWZvcmU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMucnVsZShwYXJ0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5wb3MgKz0gMTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbW1lbnQocGFydCkge1xuICAgICAgICBsZXQgdG9rZW4gPSBwYXJ0LnRva2Vuc1swXTtcbiAgICAgICAgbGV0IG5vZGUgID0gbmV3IENvbW1lbnQoKTtcbiAgICAgICAgdGhpcy5pbml0KG5vZGUsIHBhcnQpO1xuICAgICAgICBub2RlLnNvdXJjZS5lbmQgPSB7IGxpbmU6IHRva2VuWzRdLCBjb2x1bW46IHRva2VuWzVdIH07XG4gICAgICAgIHRoaXMuY29tbWVudFRleHQobm9kZSwgdG9rZW4pO1xuICAgIH1cblxuICAgIGF0cnVsZShwYXJ0KSB7XG4gICAgICAgIGxldCBhdHdvcmQgPSBwYXJ0LnRva2Vuc1swXTtcbiAgICAgICAgbGV0IHBhcmFtcyA9IHBhcnQudG9rZW5zLnNsaWNlKDEpO1xuXG4gICAgICAgIGxldCBub2RlICA9IG5ldyBBdFJ1bGUoKTtcbiAgICAgICAgbm9kZS5uYW1lID0gYXR3b3JkWzFdLnNsaWNlKDEpO1xuICAgICAgICB0aGlzLmluaXQobm9kZSwgcGFydCk7XG5cbiAgICAgICAgaWYgKCBub2RlLm5hbWUgPT09ICcnICkgdGhpcy51bm5hbWVkQXRydWxlKGF0d29yZCk7XG5cbiAgICAgICAgd2hpbGUgKCAhcGFydC5lbmQgJiYgcGFydC5sYXN0Q29tbWEgKSB7XG4gICAgICAgICAgICB0aGlzLnBvcyArPSAxO1xuICAgICAgICAgICAgcGFydCA9IHRoaXMucGFydHNbdGhpcy5wb3NdO1xuICAgICAgICAgICAgcGFyYW1zLnB1c2goWydzcGFjZScsIHBhcnQuYmVmb3JlICsgcGFydC5pbmRlbnRdKTtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcy5jb25jYXQocGFydC50b2tlbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgbm9kZS5yYXdzLmFmdGVyTmFtZSA9IHRoaXMuZmlyc3RTcGFjZXMocGFyYW1zKTtcbiAgICAgICAgdGhpcy5rZWVwVHJhaWxpbmdTcGFjZShub2RlLCBwYXJhbXMpO1xuICAgICAgICB0aGlzLnJhdyhub2RlLCAncGFyYW1zJywgcGFyYW1zLCBhdHdvcmQpO1xuICAgIH1cblxuICAgIGRlY2wocGFydCkge1xuICAgICAgICBsZXQgbm9kZSA9IG5ldyBEZWNsYXJhdGlvbigpO1xuICAgICAgICB0aGlzLmluaXQobm9kZSwgcGFydCk7XG5cbiAgICAgICAgbGV0IGJldHdlZW4gPSAnJztcbiAgICAgICAgbGV0IGNvbG9uICAgPSAwO1xuICAgICAgICBsZXQgdmFsdWUgICA9IFtdO1xuICAgICAgICBsZXQgcHJvcCAgICA9ICcnO1xuICAgICAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBwYXJ0LnRva2Vucy5sZW5ndGg7IGkrKyApIHtcbiAgICAgICAgICAgIGxldCB0b2tlbiA9IHBhcnQudG9rZW5zW2ldO1xuICAgICAgICAgICAgaWYgKCB0b2tlblswXSA9PT0gJzonICkge1xuICAgICAgICAgICAgICAgIGJldHdlZW4gKz0gdG9rZW5bMV07XG4gICAgICAgICAgICAgICAgY29sb24gICAgPSB0b2tlbjtcbiAgICAgICAgICAgICAgICB2YWx1ZSAgICA9IHBhcnQudG9rZW5zLnNsaWNlKGkgKyAxKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIHRva2VuWzBdID09PSAnY29tbWVudCcgfHwgdG9rZW5bMF0gPT09ICdzcGFjZScgKSB7XG4gICAgICAgICAgICAgICAgYmV0d2VlbiArPSB0b2tlblsxXTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGJldHdlZW4gIT09ICcnICkge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFkUHJvcCh0b2tlbik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb3AgKz0gdG9rZW5bMV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIHByb3AgPT09ICcnICkgdGhpcy51bm5hbWVkRGVjbChwYXJ0LnRva2Vuc1swXSk7XG4gICAgICAgIG5vZGUucHJvcCA9IHByb3A7XG5cbiAgICAgICAgbGV0IG5leHQgPSB0aGlzLnBhcnRzW3RoaXMucG9zICsgMV07XG5cbiAgICAgICAgd2hpbGUgKCAhbmV4dC5lbmQgJiYgIW5leHQuYXRydWxlICYmICFuZXh0LmNvbG9uICYmXG4gICAgICAgICAgICAgICAgbmV4dC5pbmRlbnQubGVuZ3RoID4gcGFydC5pbmRlbnQubGVuZ3RoICkge1xuICAgICAgICAgICAgdmFsdWUucHVzaChbJ3NwYWNlJywgbmV4dC5iZWZvcmUgKyBuZXh0LmluZGVudF0pO1xuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5jb25jYXQobmV4dC50b2tlbnMpO1xuICAgICAgICAgICAgdGhpcy5wb3MgKz0gMTtcbiAgICAgICAgICAgIG5leHQgPSB0aGlzLnBhcnRzW3RoaXMucG9zICsgMV07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbGFzdCA9IHZhbHVlW3ZhbHVlLmxlbmd0aCAtIDFdO1xuICAgICAgICBpZiAoIGxhc3QgJiYgbGFzdFswXSA9PT0gJ2NvbW1lbnQnICkge1xuICAgICAgICAgICAgdmFsdWUucG9wKCk7XG4gICAgICAgICAgICBsZXQgY29tbWVudCA9IG5ldyBDb21tZW50KCk7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnQucHVzaChjb21tZW50KTtcbiAgICAgICAgICAgIGNvbW1lbnQuc291cmNlID0ge1xuICAgICAgICAgICAgICAgIGlucHV0OiB0aGlzLmlucHV0LFxuICAgICAgICAgICAgICAgIHN0YXJ0OiB7IGxpbmU6IGxhc3RbMl0sIGNvbHVtbjogbGFzdFszXSB9LFxuICAgICAgICAgICAgICAgIGVuZDogICB7IGxpbmU6IGxhc3RbNF0sIGNvbHVtbjogbGFzdFs1XSB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbGV0IHByZXYgPSB2YWx1ZVt2YWx1ZS5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgIGlmICggcHJldiAmJiBwcmV2WzBdID09PSAnc3BhY2UnICkge1xuICAgICAgICAgICAgICAgIHZhbHVlLnBvcCgpO1xuICAgICAgICAgICAgICAgIGNvbW1lbnQucmF3cy5iZWZvcmUgPSBwcmV2WzFdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5jb21tZW50VGV4dChjb21tZW50LCBsYXN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoIGxldCBpID0gdmFsdWUubGVuZ3RoIC0gMTsgaSA+IDA7IGktLSApIHtcbiAgICAgICAgICAgIGxldCB0ID0gdmFsdWVbaV1bMF07XG4gICAgICAgICAgICBpZiAoIHQgPT09ICd3b3JkJyAmJiB2YWx1ZVtpXVsxXSA9PT0gJyFpbXBvcnRhbnQnICkge1xuICAgICAgICAgICAgICAgIG5vZGUuaW1wb3J0YW50ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoIGkgPiAwICYmIHZhbHVlW2kgLSAxXVswXSA9PT0gJ3NwYWNlJyApIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5yYXdzLmltcG9ydGFudCA9IHZhbHVlW2kgLSAxXVsxXSArICchaW1wb3J0YW50JztcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUuc3BsaWNlKGkgLSAxLCAyKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBub2RlLnJhd3MuaW1wb3J0YW50ID0gJyFpbXBvcnRhbnQnO1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZS5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggdCAhPT0gJ3NwYWNlJyAmJiB0ICE9PSAnbmV3bGluZScgJiYgdCAhPT0gJ2NvbW1lbnQnICkge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbm9kZS5yYXdzLmJldHdlZW4gPSBiZXR3ZWVuICsgdGhpcy5maXJzdFNwYWNlcyh2YWx1ZSk7XG4gICAgICAgIHRoaXMucmF3KG5vZGUsICd2YWx1ZScsIHZhbHVlLCBjb2xvbik7XG4gICAgfVxuXG4gICAgcnVsZShwYXJ0KSB7XG4gICAgICAgIGxldCBub2RlID0gbmV3IFJ1bGUoKTtcbiAgICAgICAgdGhpcy5pbml0KG5vZGUsIHBhcnQpO1xuXG4gICAgICAgIGxldCBzZWxlY3RvciA9IHBhcnQudG9rZW5zO1xuICAgICAgICBsZXQgbmV4dCAgICAgPSB0aGlzLnBhcnRzW3RoaXMucG9zICsgMV07XG5cbiAgICAgICAgd2hpbGUgKCAhbmV4dC5lbmQgJiYgbmV4dC5pbmRlbnQubGVuZ3RoID09PSBwYXJ0LmluZGVudC5sZW5ndGggKSB7XG4gICAgICAgICAgICBzZWxlY3Rvci5wdXNoKFsnc3BhY2UnLCBuZXh0LmJlZm9yZSArIG5leHQuaW5kZW50XSk7XG4gICAgICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLmNvbmNhdChuZXh0LnRva2Vucyk7XG4gICAgICAgICAgICB0aGlzLnBvcyArPSAxO1xuICAgICAgICAgICAgbmV4dCA9IHRoaXMucGFydHNbdGhpcy5wb3MgKyAxXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMua2VlcFRyYWlsaW5nU3BhY2Uobm9kZSwgc2VsZWN0b3IpO1xuICAgICAgICB0aGlzLnJhdyhub2RlLCAnc2VsZWN0b3InLCBzZWxlY3Rvcik7XG4gICAgfVxuXG4gICAgLyogSGVscGVycyAqL1xuXG4gICAgaW5kZW50KHBhcnQpIHtcbiAgICAgICAgbGV0IGluZGVudCA9IHBhcnQuaW5kZW50Lmxlbmd0aDtcbiAgICAgICAgbGV0IGlzUHJldiA9IHR5cGVvZiB0aGlzLnByZXZJbmRlbnQgIT09ICd1bmRlZmluZWQnO1xuXG4gICAgICAgIGlmICggIWlzUHJldiAmJiBpbmRlbnQgKSB0aGlzLmluZGVudGVkRmlyc3RMaW5lKHBhcnQpO1xuXG4gICAgICAgIGlmICggIXRoaXMuc3RlcCAmJiBpbmRlbnQgKSB7XG4gICAgICAgICAgICB0aGlzLnN0ZXAgPSBpbmRlbnQ7XG4gICAgICAgICAgICB0aGlzLnJvb3QucmF3cy5pbmRlbnQgPSBwYXJ0LmluZGVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICggaXNQcmV2ICYmIHRoaXMucHJldkluZGVudCAhPT0gaW5kZW50ICkge1xuICAgICAgICAgICAgbGV0IGRpZmYgPSBpbmRlbnQgLSB0aGlzLnByZXZJbmRlbnQ7XG4gICAgICAgICAgICBpZiAoIGRpZmYgPiAwICkge1xuICAgICAgICAgICAgICAgIGlmICggZGlmZiAhPT0gdGhpcy5zdGVwICkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLndyb25nSW5kZW50KHRoaXMucHJldkluZGVudCArIHRoaXMuc3RlcCwgaW5kZW50LCBwYXJ0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLmN1cnJlbnQubGFzdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCBkaWZmICUgdGhpcy5zdGVwICE9PSAwICkge1xuICAgICAgICAgICAgICAgIGxldCBtID0gaW5kZW50ICsgZGlmZiAlIHRoaXMuc3RlcDtcbiAgICAgICAgICAgICAgICB0aGlzLndyb25nSW5kZW50KGAkeyBtIH0gb3IgJHsgbSArIHRoaXMuc3RlcCB9YCwgaW5kZW50LCBwYXJ0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgLWRpZmYgLyB0aGlzLnN0ZXA7IGkrKyApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5jdXJyZW50LnBhcmVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnByZXZJbmRlbnQgPSBpbmRlbnQ7XG4gICAgfVxuXG4gICAgaW5pdChub2RlLCBwYXJ0KSB7XG4gICAgICAgIHRoaXMuaW5kZW50KHBhcnQpO1xuXG4gICAgICAgIGlmICggIXRoaXMuY3VycmVudC5ub2RlcyApIHRoaXMuY3VycmVudC5ub2RlcyA9IFtdO1xuICAgICAgICB0aGlzLmN1cnJlbnQucHVzaChub2RlKTtcblxuICAgICAgICBub2RlLnJhd3MuYmVmb3JlID0gcGFydC5iZWZvcmUgKyBwYXJ0LmluZGVudDtcbiAgICAgICAgbm9kZS5zb3VyY2UgPSB7XG4gICAgICAgICAgICBzdGFydDogeyBsaW5lOiBwYXJ0LnRva2Vuc1swXVsyXSwgY29sdW1uOiBwYXJ0LnRva2Vuc1swXVszXSB9LFxuICAgICAgICAgICAgaW5wdXQ6IHRoaXMuaW5wdXRcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBrZWVwVHJhaWxpbmdTcGFjZShub2RlLCB0b2tlbnMpIHtcbiAgICAgICAgbGV0IGxhc3RTcGFjZSA9IHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV07XG4gICAgICAgIGlmICggbGFzdFNwYWNlICYmIGxhc3RTcGFjZVswXSA9PT0gJ3NwYWNlJyApIHtcbiAgICAgICAgICAgIHRva2Vucy5wb3AoKTtcbiAgICAgICAgICAgIG5vZGUucmF3cy5zc3NCZXR3ZWVuID0gbGFzdFNwYWNlWzFdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZmlyc3RTcGFjZXModG9rZW5zKSB7XG4gICAgICAgIGxldCByZXN1bHQgPSAnJztcbiAgICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrICkge1xuICAgICAgICAgICAgaWYgKCB0b2tlbnNbaV1bMF0gPT09ICdzcGFjZScgfHwgdG9rZW5zW2ldWzBdID09PSAnbmV3bGluZScgKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ICs9IHRva2Vucy5zaGlmdCgpWzFdO1xuICAgICAgICAgICAgICAgIGkgLT0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICByYXcobm9kZSwgcHJvcCwgdG9rZW5zLCBhbHRMYXN0KSB7XG4gICAgICAgIGxldCB0b2tlbiwgdHlwZTtcbiAgICAgICAgbGV0IGxlbmd0aCA9IHRva2Vucy5sZW5ndGg7XG4gICAgICAgIGxldCB2YWx1ZSAgPSAnJztcbiAgICAgICAgbGV0IGNsZWFuICA9IHRydWU7XG4gICAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxICkge1xuICAgICAgICAgICAgdG9rZW4gPSB0b2tlbnNbaV07XG4gICAgICAgICAgICB0eXBlICA9IHRva2VuWzBdO1xuICAgICAgICAgICAgaWYgKCB0eXBlID09PSAnY29tbWVudCcgfHwgdHlwZSA9PT0gJ3NwYWNlJyAmJiBpID09PSBsZW5ndGggLSAxICkge1xuICAgICAgICAgICAgICAgIGNsZWFuID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbHVlICs9IHRva2VuWzFdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICggIWNsZWFuICkge1xuICAgICAgICAgICAgbGV0IHNzcyA9IHRva2Vucy5yZWR1Y2UoIChhbGwsIGkpID0+IGFsbCArIGlbMV0sICcnKTtcbiAgICAgICAgICAgIGxldCByYXcgPSB0b2tlbnMucmVkdWNlKCAoYWxsLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCBpWzBdID09PSAnY29tbWVudCcgJiYgaVs2XSA9PT0gJ2lubGluZScgKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhbGwgKyAnLyogJyArIGlbMV0uc2xpY2UoMikudHJpbSgpICsgJyAqLyc7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsbCArIGlbMV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgJycpO1xuICAgICAgICAgICAgbm9kZS5yYXdzW3Byb3BdID0geyB2YWx1ZSwgcmF3IH07XG4gICAgICAgICAgICBpZiAoIHNzcyAhPT0gcmF3ICkgbm9kZS5yYXdzW3Byb3BdLnNzcyA9IHNzcztcbiAgICAgICAgfVxuICAgICAgICBub2RlW3Byb3BdID0gdmFsdWU7XG5cbiAgICAgICAgbGV0IGxhc3QgPSB0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdIHx8IGFsdExhc3Q7XG4gICAgICAgIG5vZGUuc291cmNlLmVuZCA9IHtcbiAgICAgICAgICAgIGxpbmU6ICAgbGFzdFs0XSB8fCBsYXN0WzJdLFxuICAgICAgICAgICAgY29sdW1uOiBsYXN0WzVdIHx8IGxhc3RbM11cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBuZXh0Tm9uQ29tbWVudChwb3MpIHtcbiAgICAgICAgbGV0IG5leHQgPSBwb3M7XG4gICAgICAgIGxldCBwYXJ0O1xuICAgICAgICB3aGlsZSAoIG5leHQgPCB0aGlzLnBhcnRzLmxlbmd0aCApIHtcbiAgICAgICAgICAgIG5leHQgKz0gMTtcbiAgICAgICAgICAgIHBhcnQgPSB0aGlzLnBhcnRzW25leHRdO1xuICAgICAgICAgICAgaWYgKCBwYXJ0LmVuZCB8fCAhcGFydC5jb21tZW50ICkgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBhcnQ7XG4gICAgfVxuXG4gICAgY29tbWVudFRleHQobm9kZSwgdG9rZW4pIHtcbiAgICAgICAgbGV0IHRleHQgPSB0b2tlblsxXTtcbiAgICAgICAgaWYgKCB0b2tlbls2XSA9PT0gJ2lubGluZScgKSB7XG4gICAgICAgICAgICBub2RlLnJhd3MuaW5saW5lID0gdHJ1ZTtcbiAgICAgICAgICAgIHRleHQgPSB0ZXh0LnNsaWNlKDIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGV4dCA9IHRleHQuc2xpY2UoMiwgLTIpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG1hdGNoID0gdGV4dC5tYXRjaCgvXihcXHMqKShbXl0qW15cXHNdKShcXHMqKVxcbj8kLyk7XG4gICAgICAgIG5vZGUudGV4dCA9IG1hdGNoWzJdO1xuICAgICAgICBub2RlLnJhd3MubGVmdCA9IG1hdGNoWzFdO1xuICAgICAgICBub2RlLnJhd3MuaW5saW5lUmlnaHQgPSBtYXRjaFszXTtcbiAgICB9XG5cbiAgICAvLyBFcnJvcnNcblxuICAgIGVycm9yKG1zZywgbGluZSwgY29sdW1uKSB7XG4gICAgICAgIHRocm93IHRoaXMuaW5wdXQuZXJyb3IobXNnLCBsaW5lLCBjb2x1bW4pO1xuICAgIH1cblxuICAgIHVubmFtZWRBdHJ1bGUodG9rZW4pIHtcbiAgICAgICAgdGhpcy5lcnJvcignQXQtcnVsZSB3aXRob3V0IG5hbWUnLCB0b2tlblsyXSwgdG9rZW5bM10pO1xuICAgIH1cblxuICAgIHVubmFtZWREZWNsKHRva2VuKSB7XG4gICAgICAgIHRoaXMuZXJyb3IoJ0RlY2xhcmF0aW9uIHdpdGhvdXQgbmFtZScsIHRva2VuWzJdLCB0b2tlblszXSk7XG4gICAgfVxuXG4gICAgaW5kZW50ZWRGaXJzdExpbmUocGFydCkge1xuICAgICAgICB0aGlzLmVycm9yKCdGaXJzdCBsaW5lIHNob3VsZCBub3QgaGF2ZSBpbmRlbnQnLCBwYXJ0Lm51bWJlciwgMSk7XG4gICAgfVxuXG4gICAgd3JvbmdJbmRlbnQoZXhwZWN0ZWQsIHJlYWwsIHBhcnQpIHtcbiAgICAgICAgbGV0IG1zZyA9IGBFeHBlY3RlZCAkeyBleHBlY3RlZCB9IGluZGVudCwgYnV0IGdldCAkeyByZWFsIH1gO1xuICAgICAgICB0aGlzLmVycm9yKG1zZywgcGFydC5udW1iZXIsIDEpO1xuICAgIH1cblxuICAgIGJhZFByb3AodG9rZW4pIHtcbiAgICAgICAgdGhpcy5lcnJvcignVW5leHBlY3RlZCBzZXBhcmF0b3IgaW4gcHJvcGVydHknLCB0b2tlblsyXSwgdG9rZW5bM10pO1xuICAgIH1cblxufVxuIl19